<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,0,0"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
    <title>memo-app</title>
  </head>
  <body>
    <h1>memo-app</h1>
    <div>
      <div id="searchBox">
        <input type="search" id="memoSearch" placeholder="title or tag" />
        <button type="button" id="iconSearch" onclick="searchMemo()">
          <span class="material-symbols-outlined"> search </span>
        </button>
      </div>
      <div id="popup-wrapper">
        <div id="popup-inside">
          <div id="close">x</div>
          <div id="message">
            <ul id="searchResult"></ul>
          </div>
        </div>
      </div>
      <div id="memoList"></div>
      <div class="create-btn">
        <button id="btn-create" type="button" class="material-symbols-outlined">
          <span class="material-symbols add"> add </span>
        </button>
      </div>
      <div id="popupCreate" class="popup">
        <div class="popupInside">
          <div><span id="close" class="material-symbols-outlined"> close </span></div>
          <div class="code-btn">
            <button type="button" onclick="addCode(1)" class="material-symbols-outlined">
              <span class="material-symbols code"> code </span>
            </button>
          </div>
          <div id="inputArea">
            <div class="box">
              <div class="title">
                <label>Title</label>
                <textarea id="memoTitle"></textarea>
              </div>
              <div class="content">
                <label>Contents</label>
                <textarea id="memoContents"></textarea>
              </div>
              <div class="tags">
                <label>Tags</label>
                <textarea id="memoTags"></textarea>
              </div>
              <div class="save-btn">
                <button id="btn-save">Save</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="popupEdit" class="popup">
        <div class="popupInside">
          <div><span id="close" class="material-symbols-outlined"> close </span></div>
          <div class="code-btn">
            <button type="button" onclick="addCode(0)" class="material-symbols-outlined">
              <span class="material-symbols code"> code </span>
            </button>
          </div>
          <div id="inputArea">
            <div class="box">
              <div class="title">
                <label>Title</label>
                <textarea id="editTitle"></textarea>
              </div>
              <div class="content">
                <label>Contents</label>
                <textarea id="editContents"></textarea>
              </div>
              <div class="tags">
                <label>Tags</label>
                <textarea id="editTags"></textarea>
              </div>
              <div class="edit-btn">
                <button type="button" onclick="saveMemo(0)">Edit</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="popupShow" class="popup">
        <div class="popupInside">
          <div><span id="delete" class="material-symbols-outlined"> delete </span></div>
          <div><span id="edit" class="material-symbols-outlined"> edit_note </span></div>
          <div><span id="close" class="material-symbols-outlined"> close </span></div>
          <div id="inputArea">
            <div class="box">
              <div class="title show">
                <h2 id="showTitle"></h2>
              </div>
              <div class="content show">
                <div id="contentsListArea" class="contentsList"></div>
              </div>
              <div class="tags show">
                <p id="showTags"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script type="module">
    import { createMemo, saveMemo } from "./util.js";

    document.getElementById("btn-create").addEventListener("click", createMemo);
    document.getElementById("btn-save").addEventListener("click", function () {
      saveMemo(1);
    });
  </script>
  <script>
    // localStorageからメモ取得。JSONで返す
    function readMemo(key) {
      const memo = JSON.parse(localStorage.getItem(key));
      return memo;
    }

    // リストへのメモ追加
    function appendMemo(key) {
      const memo = readMemo(key);

      const list = document.getElementById("memoList");
      const div = document.createElement("div");
      div.className = "memo";
      div.id = key;
      div.setAttribute("onclick", "clickMemo(event)");
      const line = document.createElement("hr");
      const titleText = document.createElement("p");
      titleText.innerText = memo.title;
      titleText.className = "title-text";
      div.appendChild(line);
      div.appendChild(titleText);
      list.appendChild(div);
    }

    // 表示されたメモのクリック時
    function clickMemo(e) {
      console.log("clickMemo");
      const key = e.target.id;
      index = key;
      const popupWrapper = document.getElementById("popupShow");
      const closebtn = document.getElementById("close");
      const deletebtn = document.getElementById("delete");
      const editbtn = document.getElementById("edit");
      const title = document.getElementById("showTitle");
      // const contents = document.getElementById("showContents");
      const tags = document.getElementById("showTags");
      const memo = readMemo(key);

      title.innerText = memo.title;
      tags.innerText = memo.tags;

      splitContent(memo.contents);

      // ポップアップ表示
      popupWrapper.style.display = "block";

      console.log(localStorage.getItem(key));

      const clickEventListener = (e) => {
        const contentslist = document.getElementById("contentsListArea");
        if (e.target.id === popupWrapper.id || e.target.id === closebtn.id) {
          popupWrapper.style.display = "none";
          popupWrapper.removeEventListener("click", clickEventListener);
          title.innerText = ``;
          contentslist.innerHTML = ``;
          tags.innerText = ``;
        } else if (e.target.id === editbtn.id) {
          console.log("edit");
          popupWrapper.style.display = "none";
          popupWrapper.removeEventListener("click", clickEventListener);
          title.innerText = ``;
          contentslist.innerHTML = ``;
          tags.innerText = ``;
          editMemo(key);
        } else if (e.target.id === deletebtn.id) {
          popupWrapper.style.display = "none";
          popupWrapper.removeEventListener("click", clickEventListener);
          title.innerText = ``;
          contentslist.innerHTML = ``;
          tags.innerText = ``;
          deleteMemo(key);
          refreshMemo();
        }
      };

      popupWrapper.addEventListener("click", clickEventListener);
    }

    function splitContent(s) {
      let anytext = "";
      let codetext = "";
      let flip = false;
      for (let i = 0; i < s.length; i++) {
        console.log(i, s[i]);
        if (s[i] == "`") {
          if (i == 0) {
            flip = true;
            continue;
          } else if (flip == true && i != 0) {
            flip = false;
            // codetext追加
            const li = document.getElementById("contentsListArea");
            const div = document.createElement("div");
            const pre = document.createElement("pre");
            pre.className = "prettyprint";
            const code = document.createElement("code");
            code.innerText = codetext;
            pre.appendChild(code);
            div.appendChild(pre);
            li.appendChild(div);
            codetext = "";
            continue;
          } else if (flip == false && i != 0) {
            flip = true;
            // anytext追加
            const li = document.getElementById("contentsListArea");
            const div = document.createElement("div");
            const pre = document.createElement("pre");
            const p = document.createElement("p");
            p.innerText = anytext;
            pre.appendChild(p);
            div.appendChild(pre);
            li.appendChild(div);
            anytext = "";
            continue;
          }
        }

        if (flip) {
          codetext += s[i];
        } else if (!flip) {
          anytext += s[i];
        }
      }

      if (anytext.length != 0) {
        const li = document.getElementById("contentsListArea");
        const div = document.createElement("div");
        const pre = document.createElement("pre");
        const p = document.createElement("p");
        p.innerText = anytext;
        pre.appendChild(p);
        div.appendChild(pre);
        li.appendChild(div);
      }
    }
  </script>
</html>
